<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <title>INVENTARIOS ANUALES PROVEEDORA</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/html5-qrcode"></script>

  <style>
    :root{
      --wm-size: clamp(600px, 80vmin, 1400px);
      --wm-opacity: .14;
      --wm-rotate: 0deg;
      --wm-blend: normal;
      --azul:#00416A; --accent:#0c6cbd; --card:#ffffff;
    }
    *{ box-sizing: border-box }
    html,body{min-height:100%}
    body{
      font-family:'Poppins',sans-serif;
      background:linear-gradient(to right,#00416A,#E4E5E6);
      color:white; padding:16px; margin:0;
    }
    h1{ text-align:center; margin:6px 0 12px }

    .fila{ display:flex; flex-wrap:wrap; gap:10px; align-items:center }
    .folio-box{ background:white; color:#00416A; font-weight:700; padding:6px 12px; border-radius:8px; display:inline-block }
    input,button,select{ font-family:inherit; padding:12px; font-size:16px; border-radius:10px; border:none }
    input[type="text"], input[type="number"]{ width:100%; max-width:320px }
    .qty{ max-width:140px }
    input[type="number"]{ -moz-appearance:textfield }
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button{ -webkit-appearance: none; margin: 0; }
    select{ min-width:220px }
    .boton{ background:#0c6cbd; color:white; font-weight:700; cursor:pointer; transition:filter .2s; border-radius:12px }
    .boton:active{ filter:brightness(.9) }
    .btn-ghost{ background:#e8edf6; color:#0c2a5e; font-weight:600; border-radius:12px }
    .icon-btn{ width:46px; min-width:46px; padding:10px; text-align:center; font-size:18px }
    .sec{ margin-top:12px }
    .chip{ background:white; color:#00416A; border-radius:100px; padding:4px 10px; font-size:12px; font-weight:600 }
    .muted{opacity:.9}

    .view{ display:none } .view.active{ display:block }

    .contenedor-tabla{ background:var(--card); color:#111; border-radius:12px; overflow:hidden; margin-top:14px }
    table{ width:100%; border-collapse:collapse; min-width:760px }
    th,td{ padding:10px; border-bottom:1px solid #e5e7eb; vertical-align:middle }
    th{ background-color:#00416A; color:white; position:sticky; top:0; z-index:1; text-align:center }
    td{ text-align:center }

    /* Oculto el bloque de resumen anterior */
    .resumen{ display:none !important }

    /* Preview */
    .preview{ margin-top:10px; background:#ffffffdd; color:#111; border-radius:12px; padding:10px; border:2px dashed #0c6cbd; max-width:820px; }
    .preview .title{ font-weight:700; color:#0c2a5e }
    .preview .row{ display:flex; gap:12px; flex-wrap:wrap; margin-top:6px }
    .preview .pill{ background:#e8edf6; padding:6px 12px; border-radius:999px; font-weight:600; }
    .ok{ color:#1e8e3e; font-weight:700 } .warn{ color:#b36b00; font-weight:700 }

    .wm-logo{ position:fixed; inset:0; z-index:0; pointer-events:none }
    .wm-logo img{ position:absolute; top:50%; left:50%; transform:translate(-50%,-50%) rotate(var(--wm-rotate)); width:var(--wm-size); opacity:var(--wm-opacity); mix-blend-mode:var(--wm-blend) }

    main{ position:relative; z-index:1; max-width:980px; margin:0 auto }

    /* ====== MOBILE ====== */
    @media (max-width: 640px){
      body{ padding:10px }
      h1{ font-size:20px }
      .fila{ gap:8px }
      label{ width:100%; font-size:14px; opacity:.95 }
      input[type="text"], input[type="number"], select{ max-width:none; width:100% }

      /* Tabla -> Cards compactas (para el √∫ltimo registro) */
      table{ border:0; min-width:0 } thead{ display:none }
      tbody tr{
        display:block; background:#fff; margin:6px; border:1px solid #e5e7eb; border-radius:12px; overflow:hidden;
        box-shadow:0 3px 8px rgba(0,0,0,.05);
      }
      tbody td{
        display:flex; justify-content:space-between; align-items:center;
        padding:6px 10px; border-bottom:1px solid #f1f5f9; text-align:left !important; font-size:14px;
      }
      tbody td:first-child{ display:none }  /* oculta # */
      tbody td::before{
        content: attr(data-label);
        font-weight:700; color:#0c2a5e; margin-right:12px;
      }
      .fecha-cell{ font-size:12px; color:#64748b; justify-content:flex-end; }
      tbody td:last-child{ border-bottom:0 }

      /* Dock */
      .dock{
        position:fixed; left:0; right:0; bottom:0; z-index:60;
        padding:8px 10px env(safe-area-inset-bottom);
        background:linear-gradient(180deg, rgba(0,0,0,0) 0%, rgba(0,38,73,.25) 20%, rgba(0,65,106,.65) 100%);
        backdrop-filter: blur(8px);
      }
      .dock .row{ display:grid; grid-template-columns:repeat(5, 1fr); gap:10px }
      .dock .row button{ padding:12px 10px; border-radius:14px; font-weight:800; font-size:15px }
    }
    @media (max-width: 380px){
      .dock .row{ grid-template-columns:1fr 1fr 1fr 1fr 1fr }
      .dock .row button[data-role="add"]{ grid-column:auto }
    }
    @media print{ .wm-logo{ display:none } .modal{ display:none !important } .dock{ display:none !important } }

    /* Modal buscador */
    .modal{ position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:50; padding:10px }
    .modal .box{ width:min(960px,96vw); max-height:90vh; overflow:auto; background:#f9f9fb; color:#111; border-radius:12px; padding:14px; box-shadow:0 12px 28px rgba(0,0,0,0.3)}
    .modal header{ display:flex; gap:10px; align-items:center; justify-content:space-between; margin-bottom:8px; position:sticky; top:0; background:#f9f9fb; padding-bottom:6px; z-index:1 }
    .modal input[type="text"]{ border:1px solid #ddd; background:white; color:#111; width:min(560px,86vw) }
    .modal .grid{ display:grid; grid-template-columns:1fr; gap:10px }
    @media (min-width:720px){ .modal .grid{ grid-template-columns:1fr 1fr } }
    .producto-card{ border:2px solid #333; border-radius:10px; padding:10px; background:#fff; box-shadow:2px 2px 6px rgba(0,0,0,0.08) }
    .btn-ok{ background:#1e8e3e; color:white; font-weight:700; border-radius:10px; padding:8px 10px }
  </style>
</head>
<body>
  <div class="wm-logo"><img src="logo-proveedora.webp" alt=""></div>

  <main>
    <h1>INVENTARIOS ANUALES PROVEEDORA</h1>

    <!-- ===== Pantalla 1: Configuraci√≥n ===== -->
    <section id="view-setup" class="view active">
      <div class="fila">
        <div>Folio actual: <span class="folio-box" id="folio"></span></div>
        <span class="chip" id="chipModo">Modo: Acumular</span>
      </div>

      <div class="fila sec">
        <label for="sucursal">Sucursal:</label>
        <select id="sucursal">
          <option value="">-- Selecciona sucursal --</option>
          <option>Matriz</option><option>Provileon</option><option>Central</option><option>Osito</option>
          <option>Bodega Principal</option><option>Bodega Abarrotes</option><option>Bodega Dulces</option>
          <option>Zapata</option><option>Allende</option><option>Allende 2</option><option>Rio Verde</option><option>Montemorelos</option><option>Bodega 41</option>
        </select>

        <label for="usuario">Usuario:</label>
        <select id="usuario">
          <option value="">-- Selecciona usuario --</option>
          <option>Blanca</option><option>Lizandro</option><option>Edgardo</option><option>Fernanda</option>
          <option>Esmeralda</option><option>Gibran</option><option>Roberto</option>
          <option>Usuario 1</option><option>Usuario 2</option><option>Usuario 3</option><option>Usuario 4</option><option>Usuario 5</option>
        </select>
      </div>

      <div class="fila sec">
        <button class="boton" id="btnContinuar">‚û° Continuar a captura</button>
      </div>
    </section>

    <!-- ===== Pantalla 2: Captura ===== -->
    <section id="view-captura" class="view">
      <div class="fila sec" style="justify-content:space-between; gap:8px">
        <div style="flex:1 1 460px; display:flex; gap:8px; flex-wrap:wrap">
          <input type="text" id="codigo" placeholder="Escanea o escribe el c√≥digo de barras..." autocomplete="off" inputmode="numeric" style="flex:1 1 260px">
          <input type="number" id="cantidad" class="qty" placeholder="Cantidad" step="0.001" min="0.001" inputmode="decimal">
        </div>
        <!-- Bot√≥n carrito peque√±o (escritorio) -->
        <button class="btn-ghost icon-btn" id="btnResumenDesk" title="Resumen (üõí)">üõí</button>
      </div>

      <!-- Previsualizaci√≥n -->
      <div id="preview" class="preview" style="display:none">
        <div class="title">Previsualizaci√≥n del art√≠culo</div>
        <div class="row">
          <span id="pDesc" class="pill"></span>
          <span id="pCodigo" class="pill"></span>
          <span id="pPeso" class="pill" style="display:none"></span>
        </div>
        <div id="pAviso" style="margin-top:8px" class="muted"></div>
      </div>

      <div id="lector" style="display:none; background:#fff; padding:10px; border-radius:8px; width:min(420px,92vw)"></div>

      <div class="contenedor-tabla">
        <table>
          <thead>
            <tr><th>#</th><th>Descripci√≥n</th><th>C√≥digo</th><th>Cantidad</th><th>Fecha</th></tr>
          </thead>
          <tbody id="tabla-productos"></tbody>
        </table>
      </div>

      <!-- Dock inferior -->
      <div class="dock" id="dock" style="display:none">
        <div class="row">
          <button class="btn-ghost" id="dockBack">‚¨Ö Volver</button>
          <button class="btn-ghost" id="dockBuscar">üîé Buscar</button>
          <button class="btn-ghost" id="dockScan">üì∑ Escanear</button>
          <button class="btn-ghost icon-btn" id="dockResumen" title="Resumen">üõí</button>
          <button class="boton" data-role="add" id="dockAdd">‚ûï Agregar</button>
        </div>
      </div>
    </section>

    <!-- ===== Pantalla 3: Resumen de la sesi√≥n ===== -->
    <section id="view-resumen" class="view">
      <div class="contenedor-tabla">
        <table>
          <thead>
            <tr><th>C√≥digo</th><th>Descripci√≥n</th><th>Total</th></tr>
          </thead>
          <tbody id="tabla-resumen">
            <tr><td colspan="3" style="text-align:center;padding:14px">Sin datos‚Ä¶</td></tr>
          </tbody>
        </table>
      </div>

      <!-- Dock del resumen -->
      <div class="dock" id="dockResumenBar" style="display:none">
        <div class="row">
          <button class="btn-ghost" id="btnVolverCaptura">‚¨Ö Volver</button>
          <div></div><div></div><div></div>
          <button class="boton" id="btnIrInicio">üè† Inicio</button>
        </div>
      </div>
    </section>
  </main>

  <!-- Modal Buscador -->
  <div class="modal" id="modal">
    <div class="box">
      <header>
        <div class="left">
          <strong>üîé Buscador de art√≠culos</strong>
          <input type="text" id="buscador" placeholder="Escribe c√≥digo o nombre...">
        </div>
        <div class="right"><button class="btn-ghost" id="cerrarModal">‚úñ Cerrar</button></div>
      </header>

      <div class="muted" style="padding:6px 2px">
        <progress id="barraProgreso" value="0" max="100" style="width:180px"></progress>
        <span id="estado"></span>
      </div>

      <div id="resultados" class="grid"></div>

      <div class="paginacion">
        <button id="prev" class="btn-ghost" disabled>‚¨Ö Anterior</button>
        <span id="contador" class="muted"></span>
        <button id="next" class="btn-ghost" disabled>Siguiente ‚û°</button>
      </div>
    </div>
  </div>

  <footer style="text-align:center; margin-top:18px; opacity:.9">
    Powered by <b>PROVSOFT</b>
  </footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, getDoc, query, where, doc, limit } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
      authDomain: "inventariopv-643f1.firebaseapp.com",
      projectId: "inventariopv-643f1",
      storageBucket: "inventariopv-643f1.appspot.com",
      messagingSenderId: "96242533231",
      appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);
    const DEC_CANTIDAD = 3;

    const pad2 = (n) => String(n).padStart(2,'0');
    const fechaLocal = (d = new Date()) =>
      `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())} ${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;
    const roundTo = (num, dec) => Math.round((Number(num) + Number.EPSILON) * 10**dec) / 10**dec;
    const fmt = (num, dec) => Number(num ?? 0).toFixed(dec);
    const $  = (id) => document.getElementById(id);

    function generarFolio() {
      const d = new Date(), P=n=>String(n).padStart(2,'0');
      const ymd = `${d.getFullYear()}${P(d.getMonth()+1)}${P(d.getDate())}-${P(d.getHours())}${P(d.getMinutes())}${P(d.getSeconds())}`;
      const r = new Uint32Array(1); (self.crypto||window.crypto).getRandomValues(r);
      return `AnualesPDD-${ymd}-${(r[0]>>>0).toString(36).toUpperCase().slice(-5)}`;
    }
    function beep(ms=120, freq=880){
      try{ const ctx=new (window.AudioContext||window.webkitAudioContext)(); const o=ctx.createOscillator(), g=ctx.createGain();
        o.frequency.value=freq; o.connect(g); g.connect(ctx.destination); g.gain.setValueAtTime(0.2, ctx.currentTime);
        o.start(); setTimeout(()=>{o.stop(); ctx.close();}, ms);
      }catch{}
    }

    /* Refs */
    const viewSetup=$("view-setup"), viewCaptura=$("view-captura"), viewResumen=$("view-resumen");
    const tblResumen=$("tabla-resumen");
    const folioSpan=$("folio"), chipModo=$("chipModo");
    const selectSucursal=$("sucursal"), selectUsuario=$("usuario"), btnContinuar=$("btnContinuar");

    const inputCodigo=$("codigo"), inputCantidad=$("cantidad");
    const previewBox=$("preview"), pDesc=$("pDesc"), pCodigo=$("pCodigo"), pPeso=$("pPeso"), pAviso=$("pAviso");
    const tabla=$("tabla-productos");

    const modal=$("modal"), cerrarModalBtn=$("cerrarModal"), inputBuscador=$("buscador"), resultadosDiv=$("resultados");
    const barraProgreso=$("barraProgreso"), estado=$("estado"), contador=$("contador"), btnPrev=$("prev"), btnNext=$("next");

    const divLector=$("lector"),
          dock=$("dock"), dockAdd=$("dockAdd"), dockScan=$("dockScan"), dockBuscar=$("dockBuscar"), dockBack=$("dockBack"),
          dockResumen=$("dockResumen"), btnResumenDesk=$("btnResumenDesk"),
          dockResumenBar=$("dockResumenBar"), btnVolverCaptura=$("btnVolverCaptura"), btnIrInicio=$("btnIrInicio");

    /* Estado */
    let folio = localStorage.getItem("folioInventarioAnuales") || generarFolio();
    folioSpan.textContent = folio; chipModo.textContent="Modo: Acumular";
    const usuarioPrevio = localStorage.getItem("usuarioInventarioAnuales") || "";
    const sucursalPrev  = localStorage.getItem("sucursalInventarioAnuales") || "";
    if (usuarioPrevio) selectUsuario.value = usuarioPrevio;
    if (sucursalPrev)  selectSucursal.value = sucursalPrev;

    let ultimoRegistro=null, productoPreview=null, cacheProductos=JSON.parse(localStorage.getItem("cacheProductosAnuales")||"{}");
    let resumenDirty = true; // para recargar cuando abrimos la vista 3

    function persistLocal(){
      localStorage.setItem("folioInventarioAnuales", folio);
      localStorage.setItem("usuarioInventarioAnuales", selectUsuario.value);
      localStorage.setItem("sucursalInventarioAnuales", selectSucursal.value);
    }
    selectUsuario.addEventListener("change", persistLocal);
    selectSucursal.addEventListener("change", persistLocal);

    /* Navegaci√≥n y protecci√≥n refresh en captura */
    function toggleBeforeUnload(enable){
      const handler = (e)=>{ e.preventDefault(); e.returnValue=''; };
      if(enable){ window.addEventListener('beforeunload', handler); }
      else{ window.removeEventListener('beforeunload', handler); }
    }
    function setView(which){
      viewSetup.classList.toggle("active", which==="setup");
      viewCaptura.classList.toggle("active", which==="captura");
      viewResumen.classList.toggle("active", which==="resumen");
      sessionStorage.setItem('lastView', which);
      dock.style.display = (which==="captura" && window.matchMedia("(max-width: 640px)").matches) ? "block" : "none";
      dockResumenBar.style.display = (which==="resumen" && window.matchMedia("(max-width: 640px)").matches) ? "block" : "none";
      // bloquear refresh solo en captura
      toggleBeforeUnload(which==="captura");
    }
    if(sessionStorage.getItem('lastView')==='captura'){ sessionStorage.setItem('lastView','setup'); }

    btnContinuar.addEventListener("click", ()=>{
      if(!selectSucursal.value) return alert("Selecciona una sucursal");
      if(!selectUsuario.value) return alert("Selecciona un usuario");
      persistLocal();
      setView("captura");
      setTimeout(()=>inputCodigo.focus(),100);
    });

    let lector=null;
    async function backToSetup(){
      try{ if(lector){ await lector.stop(); } }catch{}
      lector=null; divLector.style.display="none";
      setView("setup"); window.scrollTo({top:0,behavior:"instant"});
    }
    dockBack.addEventListener("click", backToSetup);
    window.addEventListener("resize", ()=> setView(
      viewResumen.classList.contains("active") ? "resumen" :
      (viewCaptura.classList.contains("active") ? "captura" : "setup")
    ));

    /* Productos */
    function detectarCodigoPeso(codigoStr){
      if(/^\d{13}$/.test(codigoStr) && codigoStr.startsWith("20")){
        const base=codigoStr.substring(0,7); const pesoNum=parseInt(codigoStr.substring(7,12),10);
        return {base, pesoKg: pesoNum/1000};
      }
      return null;
    }
    async function buscarEnEquivalencias(code){
      const q=query(collection(db,"productos"), where("codigosEquivalentes","array-contains",String(code).trim()));
      const snap=await getDocs(q); if(!snap.empty){ const d=snap.docs[0]; return {principal:d.id, data:d.data()} } return null;
    }
    async function getProductoPorId(id){ const r=doc(db,"productos",id); const d=await getDoc(r); return d.exists()?{id,...d.data()}:null; }

    async function resolverProducto(codigoInput){
      const codigoStr=String(codigoInput).trim();
      const det=detectarCodigoPeso(codigoStr);
      if(det){
        const eq=await buscarEnEquivalencias(det.base);
        if(eq && eq.principal){ const d=eq.data || (await getProductoPorId(eq.principal));
          if(d) return {descripcion:d.concepto ?? "Sin descripci√≥n", codigo:eq.principal, cantidad:roundTo(det.pesoKg,DEC_CANTIDAD), isPeso:true};
        }
      }
      if(cacheProductos[codigoStr]) return cacheProductos[codigoStr];
      let s1=await getDocs(query(collection(db,"productos"), where("activo","==",true), where("codigoBarra","==",codigoStr), limit(1)));
      if(!s1.empty){ const d=s1.docs[0].data(); return {descripcion:d.concepto ?? "Sin desc", codigo:s1.docs[0].id}; }
      const eq=await buscarEnEquivalencias(codigoStr);
      if(eq && eq.principal){ const d=eq.data || (await getProductoPorId(eq.principal)); if(d) return {descripcion:d.concepto ?? "Sin desc", codigo:eq.principal}; }
      const byId=await getProductoPorId(codigoStr); if(byId) return {descripcion:byId.concepto ?? "Sin desc", codigo:byId.id};
      throw new Error("Producto no encontrado");
    }

    async function previsualizar(){
      const codigo=(inputCodigo.value||"").trim(); if(!codigo){ ocultarPreview(); return; }
      const p=await resolverProducto(codigo);
      productoPreview={ descripcion:p.descripcion, codigo:p.codigo, cantidad:p.cantidad, isPeso:!!p.isPeso };
      pDesc.textContent=p.descripcion || "SIN DESCRIPCI√ìN";
      pCodigo.textContent=`C√≥digo: ${p.codigo}`;
      if(p.isPeso){
        pPeso.style.display="inline-block";
        pPeso.textContent=`Peso detectado: ${fmt(p.cantidad,DEC_CANTIDAD)} kg`;
        inputCantidad.value=fmt(p.cantidad,DEC_CANTIDAD);
        pAviso.innerHTML=`<span class="ok">‚úî C√≥digo de balanza detectado.</span> Ajusta la cantidad si es necesario y luego presiona <b>Agregar</b>.`;
      }else{
        pPeso.style.display="none"; inputCantidad.value="";
        pAviso.innerHTML=`<span class="warn">‚åõ Previsualizaci√≥n lista.</span> Captura la cantidad y presiona <b>Agregar</b> para guardar.`;
      }
      previewBox.style.display="block";
    }
    function ocultarPreview(){ previewBox.style.display="none"; pDesc.textContent=""; pCodigo.textContent=""; pPeso.textContent=""; pPeso.style.display="none"; pAviso.textContent=""; productoPreview=null; }

    inputCodigo.addEventListener("keydown", e=>{
      if(e.key==="Enter"){ e.preventDefault(); previsualizar().then(()=> inputCantidad.focus()); }
    });
    inputCodigo.addEventListener("blur", ()=>{ if(inputCodigo.value.trim()) previsualizar(); });

    async function guardarRegistroInmediato(item){
      if(!selectSucursal.value) throw new Error("Selecciona una sucursal");
      if(!selectUsuario.value) throw new Error("Selecciona un usuario");
      const registro={
        folioSesion: folio, folioRegistro: generarFolio(), fecha: fechaLocal(), epochMs: Date.now(),
        sucursal: selectSucursal.value, usuario: selectUsuario.value,
        descripcion: item.descripcion, codigo: item.codigo, cantidad: Number(item.cantidad || 0)
      };
      await addDoc(collection(db,"inventarios", selectSucursal.value, "usuarios", selectUsuario.value, "escaneos"), registro);
      resumenDirty = true; // marca que hay cambios para el resumen
      ultimoRegistro=registro; renderTablaUltimo();
    }

    function renderTablaUltimo(){
      tabla.innerHTML="";
      if(!ultimoRegistro) return;
      const p=ultimoRegistro;
      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td data-label="#">1</td>
        <td data-label="Desc">${p.descripcion}</td>
        <td data-label="Cod">${p.codigo}</td>
        <td data-label="Cant">${fmt(p.cantidad, DEC_CANTIDAD)}</td>
        <td class="fecha-cell">${p.fecha || ""}</td>
      `;
      tabla.appendChild(tr);
      persistLocal();
    }

    const agregarYGuardar = async ()=>{
      try{
        let p=productoPreview; if(!p){ await previsualizar(); p=productoPreview; }
        if(!p) throw new Error("Primero escanea/escribe un c√≥digo v√°lido");
        let cantidad=roundTo(parseFloat(inputCantidad.value || (p.cantidad ?? "1")), DEC_CANTIDAD);
        if(isNaN(cantidad) || cantidad<=0) throw new Error("Cantidad inv√°lida");

        await guardarRegistroInmediato({ descripcion:p.descripcion, codigo:p.codigo, cantidad });
        inputCodigo.value=""; inputCantidad.value=""; ocultarPreview(); inputCodigo.focus();
      }catch(e){ alert(e.message || "Error al guardar"); }
    };

    /* Buscador */
    function abrirModal(){ modal.style.display="flex"; inputBuscador.focus(); }
    function cerrarModal(){ modal.style.display="none"; resultadosDiv.innerHTML=""; contador.textContent=""; estado.textContent=""; barraProgreso.value=0; }
    cerrarModalBtn.addEventListener("click", cerrarModal);
    modal.addEventListener("click", (e)=>{ if(e.target===modal) cerrarModal(); });
    let resultados=[], pagina=0; const porPagina=20; let debounceTimer;
    inputBuscador.addEventListener("input", ()=>{ clearTimeout(debounceTimer); const t=inputBuscador.value.trim(); if(!t){ resultadosDiv.innerHTML=""; contador.textContent=""; return; } debounceTimer=setTimeout(()=>buscarProductos(t),600); });
    btnPrev.addEventListener("click", ()=>mostrarPagina(pagina-1));
    btnNext.addEventListener("click", ()=>mostrarPagina(pagina+1));

    async function buscarProductos(termino){
      resultados=[]; resultadosDiv.innerHTML="‚è≥ Buscando..."; barraProgreso.value=10; estado.textContent="";
      if(/^\d+$/.test(termino)){
        let s1=await getDocs(query(collection(db,"productos"), where("activo","==",true), where("codigoBarra","==",termino), limit(1)));
        let encontradoEn="codigoBarra";
        if(s1.empty){
          const s2=await getDocs(query(collection(db,"productos"), where("activo","==",true), where("codigosEquivalentes","array-contains",termino), limit(1)));
          if(!s2.empty){ s1=s2; encontradoEn="equivalente"; }
        }
        if(!s1.empty){
          resultados=s1.docs.map(d=>({id:d.id, ...d.data(), coincidencia:encontradoEn, codigoBuscado:termino}));
        }else{
          resultadosDiv.innerHTML="‚ùå No se encontr√≥ este c√≥digo en productos ni en equivalentes"; contador.textContent=""; barraProgreso.value=100; return;
        }
        barraProgreso.value=100; mostrarPagina(0); return;
      }
      barraProgreso.value=25; estado.textContent="Cargando productos activos‚Ä¶";
      const snap=await getDocs(query(collection(db,"productos"), where("activo","==",true)));
      const palabras=termino.toLowerCase().split(/\s+/).filter(Boolean);
      resultados=[]; snap.forEach(docu=>{ const p={id:docu.id, ...docu.data()}; if(p.concepto && palabras.every(w=>String(p.concepto).toLowerCase().includes(w))) resultados.push(p); });
      barraProgreso.value=100; estado.textContent="";
      if(!resultados.length){ resultadosDiv.innerHTML="‚ùå No se encontraron resultados"; contador.textContent=""; } else mostrarPagina(0);
    }
    function mostrarPagina(n){
      pagina=n; resultadosDiv.innerHTML="";
      const inicio=pagina*porPagina, fin=inicio+porPagina, lista=resultados.slice(inicio,fin);
      lista.forEach(p=>{
        const div=document.createElement("div"); div.className="producto-card";
        const badge = p.coincidencia==="equivalente" ? `<div style="color:#b00; font-size:12px">üîó Coincidencia en equivalente (${p.codigoBuscado})</div>` : "";
        div.innerHTML=`
          <b>${p.concepto || "SIN CONCEPTO"}</b><br>
          C√≥digo: ${p.codigoBarra || p.id}
          ${badge}
          <div style="margin-top:8px"><button class="btn-ok">Usar en previsualizaci√≥n</button></div>
        `;
        div.querySelector(".btn-ok").addEventListener("click", ()=>{
          productoPreview={ descripcion:p.concepto || "Sin desc", codigo:p.id };
          pDesc.textContent=productoPreview.descripcion; pCodigo.textContent=`C√≥digo: ${productoPreview.codigo}`;
          pPeso.style.display="none"; pAviso.innerHTML=`<span class="warn">‚åõ Previsualizaci√≥n lista.</span> Captura la cantidad y presiona <b>Agregar</b>.`;
          previewBox.style.display="block"; cerrarModal(); inputCantidad.value=""; inputCantidad.focus();
        });
        resultadosDiv.appendChild(div);
      });
      contador.textContent=`Resultados: ${resultados.length} | P√°gina ${pagina+1} de ${Math.max(1,Math.ceil(resultados.length/porPagina))}`;
      btnPrev.disabled=pagina===0; btnNext.disabled=fin>=resultados.length;
    }

    /* Esc√°ner */
    async function startStopCam(){
      if(lector){ try{ await lector.stop(); }catch{} lector=null; divLector.style.display="none"; return; }
      divLector.style.display="block"; lector=new Html5Qrcode("lector");
      try{
        const box=Math.floor(Math.min(window.innerWidth*0.8, 320));
        await lector.start(
          { facingMode:"environment" }, { fps:10, qrbox:box },
          async codigo=>{
            try{ await lector.stop(); }catch{} lector=null; divLector.style.display="none";
            inputCodigo.value=codigo;
            try{ await previsualizar(); beep(); inputCantidad.focus(); }
            catch{ abrirModal(); inputBuscador.value=codigo; buscarProductos(codigo); }
          }, err=>{}
        );
      }catch(e){ console.error("Error c√°mara:", e); alert("No se pudo abrir la c√°mara"); }
    }

    /* ======= Resumen (Pantalla 3) ======= */
    async function cargarResumenSesion(){
      // Re√∫ne y agrupa por c√≥digo los registros del folio actual
      const colRef = collection(db,"inventarios", selectSucursal.value, "usuarios", selectUsuario.value, "escaneos");
      const snap = await getDocs(query(colRef, where("folioSesion","==",folio)));
      const mapa = new Map();
      snap.forEach(d=>{
        const r=d.data();
        const k=r.codigo;
        const prev = mapa.get(k) || {codigo:k, descripcion:r.descripcion||"", total:0};
        prev.total += Number(r.cantidad||0);
        mapa.set(k, prev);
      });

      const filas = [...mapa.values()].sort((a,b)=> a.descripcion.localeCompare(b.descripcion, 'es'));
      tblResumen.innerHTML = filas.length
        ? filas.map(x=>`<tr><td>${x.codigo}</td><td style="text-align:left">${x.descripcion}</td><td>${fmt(x.total, DEC_CANTIDAD)}</td></tr>`).join("")
        : `<tr><td colspan="3" style="text-align:center;padding:14px">Sin datos‚Ä¶</td></tr>`;
    }

    function irResumen(){
      if(!selectSucursal.value || !selectUsuario.value){ alert("Primero selecciona sucursal y usuario en la pantalla inicial."); return; }
      setView("resumen");
      if(resumenDirty){ cargarResumenSesion().finally(()=>{ resumenDirty=false; }); }
    }
    function volverACaptura(){ setView("captura"); }

    // botones para abrir/volver resumen
    dockResumen.addEventListener("click", irResumen);
    btnResumenDesk.addEventListener("click", irResumen);
    btnVolverCaptura.addEventListener("click", volverACaptura);
    btnIrInicio.addEventListener("click", backToSetup);

    /* Dock acciones */
    dockAdd.addEventListener("click", agregarYGuardar);
    dockBuscar.addEventListener("click", abrirModal);
    dockScan.addEventListener("click", startStopCam);

    /* Inicia en setup */
    setView("setup");
  </script>
</body>
</html>
