<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>INVENTARIOS ANUALES PROVEEDORA</title>

  <!-- Fuente y librerÃ­as -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>

  <style>
    :root{
      --wm-size: clamp(600px, 80vmin, 1400px);
      --wm-opacity: .14;
      --wm-rotate: 0deg;
      --wm-blend: normal;
      --azul:#00416A; --accent:#0c6cbd;
    }
    *{ box-sizing: border-box }
    body{
      font-family:'Poppins',sans-serif;
      background:linear-gradient(to right,#00416A,#E4E5E6);
      color:white; padding:20px; margin:0; min-height:100vh;
    }
    h1{ text-align:center; margin-bottom:12px }

    .fila{ display:flex; flex-wrap:wrap; gap:10px; align-items:center }
    .folio-box{ background:white; color:#00416A; font-weight:bold; padding:6px 12px; border-radius:8px; display:inline-block }
    input,button,select{ font-family:inherit; padding:10px; font-size:16px; border-radius:6px; border:none }
    input[type="text"], input[type="number"]{ width:100%; max-width:320px }
    select{ min-width:220px }
    .acciones button{ width:auto }
    .boton{ background:#0c6cbd; color:white; font-weight:bold; cursor:pointer; transition:background .25s }
    .boton:hover{ background:#084f92 }
    .sec{ margin-top:12px }
    .contenedor-tabla{ background:white; color:black; border-radius:8px; overflow-x:auto; margin-top:14px }
    table{ width:100%; border-collapse:collapse; min-width:760px }
    th,td{ padding:10px; border:1px solid #ccc; text-align:center; vertical-align:middle }
    th{ background-color:#00416A; color:white; position:sticky; top:0 }
    .resumen{ background:rgba(255,255,255,.15); border:1px solid rgba(255,255,255,.25); border-radius:10px; padding:10px; display:flex; gap:16px; flex-wrap:wrap }
   /* ocultar costo, importe y fecha */
thead th:nth-child(5), thead th:nth-child(6), thead th:nth-child(7),
tbody td:nth-child(5), tbody td:nth-child(6), tbody td:nth-child(7){display:none;}
    .wm-logo{ position:fixed; inset:0; z-index:0; pointer-events:none; }
    .wm-logo img{
      position:absolute; top:50%; left:50%;
      transform: translate(-50%, -50%) rotate(var(--wm-rotate));
      width: var(--wm-size); height:auto;
      opacity: var(--wm-opacity);
      mix-blend-mode: var(--wm-blend);
      filter: grayscale(20%) saturate(120%) contrast(105%);
    }
    main{ position:relative; z-index:1; }

    .muted{opacity:.9}
    .chip{ background:white; color:#00416A; border-radius:100px; padding:4px 10px; font-size:12px; font-weight:600 }

    /* Modal buscador */
    .modal{ position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:10; }
    .modal .box{
      width:min(960px,96vw); max-height:90vh; overflow:auto; background:#f9f9fb; color:#111; border-radius:12px; padding:14px; box-shadow:0 12px 28px rgba(0,0,0,.3)
    }
    .modal header{ display:flex; gap:10px; align-items:center; justify-content:space-between; margin-bottom:8px }
    .modal header .left{ display:flex; gap:10px; align-items:center; flex-wrap:wrap }
    .modal input[type="text"]{ border:1px solid #ddd; background:white; color:#111; width: min(560px, 86vw) }
    .modal .grid{ display:grid; grid-template-columns:1fr; gap:10px }
    @media (min-width:720px){ .modal .grid{ grid-template-columns:1fr 1fr } }
    .producto-card{
      border:2px solid #333; border-radius:8px; padding:10px; background:#fff;
      box-shadow: 2px 2px 6px rgba(0,0,0,0.08);
    }
    .precios{ margin-top:6px; display:flex; flex-direction:column; gap:2px; font-size:14px }
    .precio-publico{ font-weight:700; color:#1a7c1a }
    .precio-medio{ color:#004080 }
    .precio-mayoreo{ color:#b36b00 }
    .paginacion{ display:flex; gap:8px; justify-content:center; align-items:center; padding:8px 0; }
    .btn-ghost{ background:#e8edf6; color:#0c2a5e; font-weight:600 }
    .btn-danger{ background:#d62828; color:white; font-weight:600 }
    .btn-ok{ background:#1e8e3e; color:white; font-weight:700 }

    /* Tarjeta de previsualizaciÃ³n */
    .preview{
      margin-top:10px; background:#ffffffdd; color:#111; border-radius:10px; padding:10px;
      border:2px dashed #0c6cbd; max-width:820px;
    }
    .preview .title{ font-weight:700; color:#0c2a5e }
    .preview .row{ display:flex; gap:12px; flex-wrap:wrap; margin-top:6px }
    .preview .pill{ background:#e8edf6; padding:4px 10px; border-radius:999px; font-weight:600; }
    .ok{ color:#1e8e3e; font-weight:700 }
    .warn{ color:#b36b00; font-weight:700 }

    @media print{ .wm-logo{ display:none } .modal{ display:none !important } }
  </style>
</head>
<body>
  <div class="wm-logo"><img src="logo-proveedora.webp" alt=""></div>

  <main>
    <h1>INVENTARIOS ANUALES PROVEEDORA</h1>

    <div class="fila">
      <div>Folio actual: <span class="folio-box" id="folio"></span></div>
      <span class="chip" id="chipModo">Modo: Acumular</span>
    </div>

    <!-- Palabra clave + Sucursal + Usuario -->
    <div class="fila sec">
      <label for="palabraClave" style="min-width:140px">Palabra clave:</label>
      <input type="text" id="palabraClave" placeholder="Ej. BODEGA, URGENTE, PROV">

      <label for="sucursal" style="min-width:100px">Sucursal:</label>
      <select id="sucursal">
        <option value="">-- Selecciona sucursal --</option>
        <option>osito</option>
        <option>provileon</option>
        <option>central</option>
        <option>matriz</option>
        <option>bodega saul</option>
        <option>bodega abarrotes</option>
        <option>bodega dulces</option>
        <option>zapata</option>
        <option>allende</option>
        <option>allende 2</option>
      </select>

      <label for="usuario" style="min-width:100px">Usuario:</label>
      <select id="usuario">
        <option value="">-- Selecciona usuario --</option>
        <option value="Blanca">Blanca</option>
        <option value="Lizandro">Lizandro</option>
        <option value="Edgardo">Edgardo</option>
        <option value="Fernanda">Fernanda</option>
        <option value="Vansessa">Vansessa</option>
        <option value="Esmeralda">Esmeralda</option>
        <option value="Gibran">Gibran</option>
        <option value="Roberto">Roberto</option>
        <option value="Usuario 1">Usuario 1</option>
        <option value="Usuario 2">Usuario 2</option>
        <option value="Usuario 3">Usuario 3</option>
        <option value="Usuario 4">Usuario 4</option>
        <option value="Usuario 5">Usuario 5</option>
      </select>
    </div>

    <div class="fila sec">
      <input type="text" id="codigo" placeholder="Escanea o escribe el cÃ³digo de barras...">
      <input type="number" id="cantidad" placeholder="Cantidad" value="1.000" step="0.001" min="0.001">
      <button class="boton" id="agregar">âž• Agregar (guardar)</button>
      <button class="boton" id="abrirBuscador">ðŸ”Ž Buscar</button>
      <button class="boton" id="scanBtn">ðŸ“· Escanear</button>
    </div>

    <!-- PrevisualizaciÃ³n -->
    <div id="preview" class="preview" style="display:none">
      <div class="title">PrevisualizaciÃ³n del artÃ­culo</div>
      <div class="row">
        <span id="pDesc" class="pill"></span>
        <span id="pCodigo" class="pill"></span>
        <span id="pPrecio" class="pill"></span>
        <span id="pPeso" class="pill" style="display:none"></span>
      </div>
      <div id="pAviso" style="margin-top:8px" class="muted"></div>
    </div>

    <div id="lector" style="display:none; background:#fff; padding:10px; border-radius:8px; width:min(360px,92vw)"></div>

    <div class="fila acciones sec">
      <!-- Quitado botÃ³n Guardar Inventario -->
      <button class="boton" id="exportar-actual">ðŸ“¥ Descargar Excel (Ãºltimo)</button>
      <button class="btn-danger" id="limpiar">ðŸ§¹ Limpiar (solo limpia la vista)</button>
    </div>

    <div class="contenedor-tabla">
      <table>
        <thead>
          <tr>
           <th>#</th><th>DescripciÃ³n</th><th>CÃ³digo</th><th>Cantidad</th><th>Costo</th><th>Importe</th><th>Fecha</th>
          </tr>
        </thead>
        <tbody id="tabla-productos"></tbody>
      </table>
    </div>

    <div class="resumen sec">
      <div><b>Renglones (solo Ãºltimo):</b> <span id="tRenglones">0</span></div>
      <div><b>Cantidad (Ãºltimo):</b> <span id="tCantidad">0.000</span></div>
    </div>
  </main>

  <!-- Modal Buscador -->
  <div class="modal" id="modal">
    <div class="box">
      <header>
        <div class="left">
          <strong>ðŸ”Ž Buscador de artÃ­culos</strong>
          <input type="text" id="buscador" placeholder="Escribe cÃ³digo o nombre...">
        </div>
        <div class="right">
          <button class="btn-ghost" id="cerrarModal">âœ– Cerrar</button>
        </div>
      </header>

      <div class="muted" style="padding:6px 2px">
        <progress id="barraProgreso" value="0" max="100" style="width:180px"></progress>
        <span id="estado"></span>
      </div>

      <div id="resultados" class="grid"></div>

      <div class="paginacion">
        <button id="prev" class="btn-ghost" disabled>â¬… Anterior</button>
        <span id="contador" class="muted"></span>
        <button id="next" class="btn-ghost" disabled>Siguiente âž¡</button>
      </div>
    </div>
  </div>

  <footer style="text-align:center; margin-top:18px; opacity:.9">
    Powered by <b>PROVSOFT</b>
  </footer>

  <script type="module">
    // ----------------- Firebase -----------------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, collection, addDoc, getDocs, getDoc, query, where, doc, limit
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const DEC_CANTIDAD = 3, DEC_PRECIO = 2, DEC_IMPORTE = 2;

    const firebaseConfig = {
      apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
      authDomain: "inventariopv-643f1.firebaseapp.com",
      projectId: "inventariopv-643f1",
      storageBucket: "inventariopv-643f1.appspot.com",
      messagingSenderId: "96242533231",
      appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ----------------- Utilidades -----------------
    const roundTo = (num, dec) => Math.round((Number(num) + Number.EPSILON) * 10**dec) / 10**dec;
    const fmt = (num, dec) => Number(num ?? 0).toFixed(dec);
    const $ = (id) => document.getElementById(id);

    const inputClave = $("palabraClave");
    const inputCodigo = $("codigo");
    const inputCantidad = $("cantidad");
    const selectUsuario = $("usuario");
    const selectSucursal = $("sucursal");
    const btnAgregar = $("agregar");
    const exportarActBtn = $("exportar-actual");
    const limpiarBtn = $("limpiar");
    const folioSpan = $("folio");
    const tabla = $("tabla-productos");
    const tRenglones = $("tRenglones");
    const tCantidad = $("tCantidad");

    const chipModo = $("chipModo");

    // Preview nodes
    const previewBox = $("preview");
    const pDesc = $("pDesc");
    const pCodigo = $("pCodigo");
    const pPrecio = $("pPrecio");
    const pPeso = $("pPeso");
    const pAviso = $("pAviso");

    // Modal buscador
    const modal = $("modal");
    const abrirBuscadorBtn = $("abrirBuscador");
    const cerrarModalBtn = $("cerrarModal");
    const inputBuscador = $("buscador");
    const resultadosDiv = $("resultados");
    const barraProgreso = $("barraProgreso");
    const estado = $("estado");
    const contador = $("contador");
    const btnPrev = $("prev");
    const btnNext = $("next");

    // EscÃ¡ner
    const scanBtn = $("scanBtn");
    const divLector = $("lector");

    // ----------------- Estado -----------------
    let ultimoRegistro = null;     // Ãºltimo guardado (para la tabla)
    let productoPreview = null;    // {descripcion,codigo,precio,cantidad?} para previsualizaciÃ³n
    let folio = localStorage.getItem("folioInventarioAnuales") || generarFolio();
    let palabraClaveGuardada = localStorage.getItem("claveInventarioAnuales") || "";
    let cacheProductos = JSON.parse(localStorage.getItem("cacheProductosAnuales") || "{}");

    chipModo.textContent = "Modo: Acumular";

    // buscador
    let resultados = [];
    let pagina = 0;
    const porPagina = 20;

    // Cargar estado (incluye sucursal/usuario)
    const usuarioPrevio = localStorage.getItem("usuarioInventarioAnuales") || "";
    const sucursalPrev = localStorage.getItem("sucursalInventarioAnuales") || "";
    if (usuarioPrevio) selectUsuario.value = usuarioPrevio;
    if (sucursalPrev) selectSucursal.value = sucursalPrev;

    folioSpan.textContent = folio;
    inputClave.value = palabraClaveGuardada;
    renderTablaUltimo();

    // ----------------- Generar folio -----------------
    function generarFolio() {
      const fecha = new Date();
      let base = `AnualesPDD-${fecha.toISOString().slice(0,10).replace(/-/g,'')}-${fecha.getHours()}${String(fecha.getMinutes()).padStart(2,'0')}${String(fecha.getSeconds()).padStart(2,'0')}`;
      const clave = inputClave?.value.trim();
      if (clave) base += `-${clave.replace(/\s+/g,"_").toUpperCase()}`;
      return base;
    }

    // ----------------- Balanzas -----------------
    function detectarCodigoPeso(codigoStr){
      if(/^\d{13}$/.test(codigoStr) && codigoStr.startsWith("20")){
        const base = codigoStr.substring(0,7);
        const pesoNum = parseInt(codigoStr.substring(7,12),10);
        const pesoKg = pesoNum/1000;
        return {base, pesoKg};
      }
      return null;
    }

    // ----------------- ResoluciÃ³n de producto -----------------
    async function buscarEnEquivalencias(codigoInput) {
      const codigoStr = String(codigoInput).trim();
      const q = query(collection(db,"productos"), where("codigosEquivalentes","array-contains",codigoStr));
      const snap = await getDocs(q);
      if(!snap.empty){
        const docu = snap.docs[0];
        return {principal: docu.id, data: docu.data()};
      }
      return null;
    }

    async function getProductoPorId(id){
      const ref = doc(db,"productos",id);
      const byId = await getDoc(ref);
      if(byId.exists()){
        return { id, ...byId.data() };
      }
      return null;
    }

async function resolverProducto(codigoInput){
  const codigoStr = String(codigoInput).trim();

  // Â¿cÃ³digo de balanza?
  const detectado = detectarCodigoPeso(codigoStr);
  if(detectado){
    const eq = await buscarEnEquivalencias(detectado.base);
    if(eq && eq.principal){
      const d = eq.data || (await getProductoPorId(eq.principal));
      if(d){
        return {
          descripcion: d.concepto ?? "Sin descripciÃ³n",
          codigo: eq.principal,
          costo: Number(d.costo ?? 0),
          cantidad: roundTo(detectado.pesoKg, DEC_CANTIDAD),
          isPeso: true
        };
      }
    }
  }

  // cache
  if(cacheProductos[codigoStr]) return cacheProductos[codigoStr];

  // codigoBarra
  let q = query(collection(db,"productos"), where("activo","==",true), where("codigoBarra","==",codigoStr), limit(1));
  let snap = await getDocs(q);
  if(!snap.empty){
    const d = snap.docs[0].data();
    return {
      descripcion: d.concepto ?? "Sin desc",
      codigo: snap.docs[0].id,
      costo: Number(d.costo ?? 0)
    };
  }

  // equivalentes
  const eq = await buscarEnEquivalencias(codigoStr);
  if(eq && eq.principal){
    const d = eq.data || (await getProductoPorId(eq.principal));
    if(d){
      return {
        descripcion: d.concepto ?? "Sin desc",
        codigo: eq.principal,
        costo: Number(d.costo ?? 0)
      };
    }
  }

  // id directo
  const byId = await getProductoPorId(codigoStr);
  if(byId){
    return {
      descripcion: byId.concepto ?? "Sin desc",
      codigo: byId.id,
      costo: Number(byId.costo ?? 0)
    };
  }

  throw new Error("Producto no encontrado");
}

    // ----------------- PREVISUALIZACIÃ“N -----------------
    async function previsualizar(){
      const codigo = (inputCodigo.value||"").trim();
      if(!codigo){ ocultarPreview(); return; }

      try{
        const p = await resolverProducto(codigo);
        productoPreview = { descripcion:p.descripcion, codigo:p.codigo, costo: p.costo ?? 0, cantidad: p.cantidad, isPeso: !!p.isPeso };

        // Pintar UI
        pDesc.textContent = p.descripcion || "SIN DESCRIPCIÃ“N";
        pCodigo.textContent = `CÃ³digo: ${p.codigo}`;
        pPrecio.textContent = `Costo: $${fmt(p.costo ?? 0, DEC_PRECIO)}`;   // ðŸ‘ˆ antes decÃ­a "Precio pÃºblico"
        if(p.isPeso){
          pPeso.style.display = "inline-block";
          pPeso.textContent = `Peso detectado: ${fmt(p.cantidad, DEC_CANTIDAD)} kg`;
          inputCantidad.value = fmt(p.cantidad, DEC_CANTIDAD);
          pAviso.innerHTML = `<span class="ok">âœ” CÃ³digo de balanza detectado.</span> Ajusta la cantidad si es necesario y luego presiona <b>Agregar</b>.`;
        }else{
          pPeso.style.display = "none";
          pAviso.innerHTML = `<span class="warn">âŒ› PrevisualizaciÃ³n lista.</span> Captura la cantidad y presiona <b>Agregar</b> para guardar.`;
        }
        previewBox.style.display = "block";
      }catch(e){
        ocultarPreview();
        alert("No se encontrÃ³ el producto");
      }
    }

    function ocultarPreview(){
      previewBox.style.display = "none";
      pDesc.textContent = "";
      pCodigo.textContent = "";
      pPrecio.textContent = "";
      pPeso.textContent = "";
      pAviso.textContent = "";
      productoPreview = null;
    }

    // Lanzar preview al presionar Enter en cÃ³digo o al salir del campo
    inputCodigo.addEventListener("keydown", e=>{
      if(e.key==="Enter"){ e.preventDefault(); previsualizar().then(()=> inputCantidad.focus()); }
    });
    inputCodigo.addEventListener("blur", ()=>{ if(inputCodigo.value.trim()) previsualizar(); });

    // ----------------- GUARDADO INMEDIATO -----------------
async function guardarRegistroInmediato(item){
  if(!selectSucursal.value) throw new Error("Selecciona una sucursal");
  if(!selectUsuario.value) throw new Error("Selecciona un usuario");

  const folioRegistro = generarFolio();
  const costo = Number(item.costo ?? 0);

  const registro = {
    folioSesion: folio,
    folioRegistro,
    fecha: new Date().toISOString(),
    sucursal: selectSucursal.value,
    usuario: selectUsuario.value,
    palabraClave: inputClave.value.trim() || null,

    descripcion: item.descripcion,
    codigo: item.codigo,
    cantidad: Number(item.cantidad || 0),
    costo,                                        // ðŸ‘ˆ guardamos costo
    importe: roundTo((+item.cantidad||0) * costo, DEC_IMPORTE)
  };

  await addDoc(
    collection(db,"inventarios", selectSucursal.value, "usuarios", selectUsuario.value, "escaneos"),
    registro
  );

  ultimoRegistro = registro;
  renderTablaUltimo();
}

    function renderTablaUltimo(){
      tabla.innerHTML = "";
      if(!ultimoRegistro){
        tRenglones.textContent = "0";
        tCantidad.textContent = "0.000";
        return;
      }
      const p = ultimoRegistro;
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>1</td>
        <td>${p.descripcion}</td>
        <td>${p.codigo}</td>
        <td>${fmt(p.cantidad, DEC_CANTIDAD)}</td>
       <td>$${fmt(p.costo, DEC_PRECIO)}</td>
        <td>$${fmt(p.importe, DEC_IMPORTE)}</td>
        <td>${(p.fecha||"").slice(0,19).replace('T',' ')}</td>
      `;
      tabla.appendChild(tr);
      tRenglones.textContent = "1";
      tCantidad.textContent = fmt(p.cantidad, DEC_CANTIDAD);
      persistLocal();
    }

    // ----------------- Agregar (usar preview y guardar) -----------------
    btnAgregar.addEventListener("click", agregarYGuardar);
    inputCantidad.addEventListener("keydown", e=>{
      if(e.key==="Enter"){ e.preventDefault(); agregarYGuardar(); }
    });

    async function agregarYGuardar(){
      try{
        let p = productoPreview;
        // Si no hay preview (p.ej. escribieron y dieron directo Agregar), resolvemos
        if(!p){
          await previsualizar();
          p = productoPreview;
        }
        if(!p) throw new Error("Primero escanea/escribe un cÃ³digo vÃ¡lido");

        let cantidad = roundTo(parseFloat(inputCantidad.value|| (p.cantidad ?? "1")), DEC_CANTIDAD);
        if(isNaN(cantidad) || cantidad<=0) throw new Error("Cantidad invÃ¡lida");

await guardarRegistroInmediato({
  descripcion: p.descripcion,
  codigo: p.codigo,
  costo: Number(p.costo ?? 0),
  cantidad
});


        // limpiar para el siguiente
        inputCodigo.value = "";
        inputCantidad.value = "1.000";
        ocultarPreview();
        inputCodigo.focus();
      }catch(e){
        alert(e.message || "Error al guardar");
      }
    }

    // ----------------- Botones Exportar / Limpiar -----------------
    exportarActBtn.addEventListener("click", ()=>{
      if(!ultimoRegistro) return alert("No hay registro reciente para exportar");
      exportarAExcel([ultimoRegistro], ultimoRegistro.folioRegistro, ultimoRegistro.sucursal);
    });

    function exportarAExcel(lista,folioReg,sucursal){
const encabezados=[["#","DescripciÃ³n","CÃ³digo","Cantidad","Costo","Importe","Fecha","FolioRegistro","Sucursal","Usuario"]];
const datos=lista.map((p,i)=>[
  i+1,p.descripcion,p.codigo,
  fmt(p.cantidad,DEC_CANTIDAD),
  fmt(p.costo,DEC_PRECIO),
  fmt(p.importe,DEC_IMPORTE),
  (p.fecha||"").slice(0,19).replace('T',' '),
  p.folioRegistro, p.sucursal||"", p.usuario||""
]);

      const wb=XLSX.utils.book_new();
      const ws=XLSX.utils.aoa_to_sheet(encabezados.concat(datos));
      XLSX.utils.book_append_sheet(wb,ws,"Ãšltimo");
      const suf = sucursal ? `_${sucursal.replace(/\s+/g,'_')}` : "";
      XLSX.writeFile(wb,`InventarioUltimo_${folioReg}${suf}.xlsx`);
    }

    limpiarBtn.addEventListener("click", ()=>{
      ultimoRegistro = null;
      renderTablaUltimo();
      ocultarPreview();
    });

    // ----------------- Buscador (modal) -----------------
    function abrirModal(){ modal.style.display="flex"; inputBuscador.focus(); }
    function cerrarModal(){ modal.style.display="none"; resultadosDiv.innerHTML=""; contador.textContent=""; estado.textContent=""; barraProgreso.value=0; }
    abrirBuscadorBtn.addEventListener("click", abrirModal);
    cerrarModalBtn.addEventListener("click", cerrarModal);
    modal.addEventListener("click", (e)=>{ if(e.target===modal) cerrarModal(); });

    let debounceTimer;
    inputBuscador.addEventListener("input", ()=>{
      clearTimeout(debounceTimer);
      const termino = inputBuscador.value.trim();
      if(!termino){ resultadosDiv.innerHTML=""; contador.textContent=""; return; }
      debounceTimer = setTimeout(()=> buscarProductos(termino), 600);
    });

    btnPrev.addEventListener("click", ()=> mostrarPagina(pagina-1));
    btnNext.addEventListener("click", ()=> mostrarPagina(pagina+1));

    async function buscarProductos(termino){
      resultados = [];
      resultadosDiv.innerHTML = "â³ Buscando...";
      barraProgreso.value = 10; estado.textContent = "";

      // Si es cÃ³digo numÃ©rico â†’ primero codigoBarra, luego equivalentes
      if(/^\d+$/.test(termino)){
        let q1 = query(collection(db,"productos"), where("activo","==",true), where("codigoBarra","==",termino), limit(1));
        let s1 = await getDocs(q1);
        let encontradoEn = "codigoBarra";

        if(s1.empty){
          const q2 = query(collection(db,"productos"), where("activo","==",true), where("codigosEquivalentes","array-contains",termino), limit(1));
          const s2 = await getDocs(q2);
          if(!s2.empty){
            s1 = s2; encontradoEn = "equivalente";
          }
        }

        if(!s1.empty){
          resultados = s1.docs.map(d => ({ id:d.id, ...d.data(), costo: Number(d.data().costo ?? 0), coincidencia:encontradoEn, codigoBuscado:termino }));
        }else{
          resultadosDiv.innerHTML = "âŒ No se encontrÃ³ este cÃ³digo en productos ni en equivalentes";
          contador.textContent = "";
          barraProgreso.value = 100;
          return;
        }

        barraProgreso.value = 100;
        mostrarPagina(0);
        return;
      }

      // Por texto (concepto)
      barraProgreso.value = 25; estado.textContent = "Cargando productos activosâ€¦";
      const q = query(collection(db,"productos"), where("activo","==",true));
      const snap = await getDocs(q);

      const palabras = termino.toLowerCase().split(/\s+/).filter(Boolean);
      resultados = [];
      snap.forEach(docu=>{
        const p = { id: docu.id, ...docu.data() };
        if(p.concepto){
          const ok = palabras.every(pal => String(p.concepto).toLowerCase().includes(pal));
          if(ok) resultados.push(p);
        }
      });
      barraProgreso.value = 100; estado.textContent = "";

      if(!resultados.length){
        resultadosDiv.innerHTML = "âŒ No se encontraron resultados";
        contador.textContent = "";
      }else{
        mostrarPagina(0);
      }
    }

    function mostrarPagina(n){
      pagina = n;
      resultadosDiv.innerHTML = "";
      const inicio = pagina * porPagina;
      const fin = inicio + porPagina;
      const lista = resultados.slice(inicio, fin);

      lista.forEach(p=>{
        const div = document.createElement("div");
        div.className = "producto-card";

        const precioPublico = p.precioPublico!=null ? Number(p.precioPublico) : (p.precio!=null ? Number(p.precio) : null);
        const medio = p.medioMayoreo!=null ? Number(p.medioMayoreo) : null;
        const mayo = p.mayoreo!=null ? Number(p.mayoreo) : null;

        const equivBadge = p.coincidencia==="equivalente"
          ? `<div style="color:#b00; font-size:12px">ðŸ”— Coincidencia en equivalente (${p.codigoBuscado})</div>`
          : "";

        div.innerHTML = `
          <b>${p.concepto || "SIN CONCEPTO"}</b><br>
          CÃ³digo: ${p.codigoBarra || p.id}
          ${equivBadge}
          <div class="precios">
            <span class="precio-publico">PÃºblico: $${precioPublico!=null ? precioPublico.toLocaleString("es-MX",{minimumFractionDigits:2,maximumFractionDigits:2}) : "â€”"}</span>
            <span class="precio-medio">Medio Mayoreo: $${medio!=null ? medio.toLocaleString("es-MX",{minimumFractionDigits:2,maximumFractionDigits:2}) : "â€”"}</span>
            <span class="precio-mayoreo">Mayoreo: $${mayo!=null ? mayo.toLocaleString("es-MX",{minimumFractionDigits:2,maximumFractionDigits:2}) : "â€”"}</span>
          </div>
          <div style="margin-top:8px">
            <button class="btn-ok">Usar en previsualizaciÃ³n</button>
          </div>
        `;

        // En buscador, no guarda directo: pasa a previsualizaciÃ³n y cierra modal
div.querySelector(".btn-ok").addEventListener("click", ()=>{
  const costo = Number(p.costo ?? 0);
  productoPreview = { descripcion: p.concepto || "Sin desc", codigo: p.id, costo };
  pDesc.textContent = productoPreview.descripcion;
  pCodigo.textContent = `CÃ³digo: ${productoPreview.codigo}`;
  pPrecio.textContent = `Costo: $${fmt(costo, DEC_PRECIO)}`;
  pPeso.style.display = "none";
  pAviso.innerHTML = `<span class="warn">âŒ› PrevisualizaciÃ³n lista.</span> Captura la cantidad y presiona <b>Agregar</b> para guardar.`;
  previewBox.style.display = "block";
  cerrarModal();
  inputCantidad.focus();
});


        resultadosDiv.appendChild(div);
      });

      contador.textContent = `Resultados: ${resultados.length} | PÃ¡gina ${pagina+1} de ${Math.max(1, Math.ceil(resultados.length/porPagina))}`;
      btnPrev.disabled = pagina===0;
      btnNext.disabled = fin >= resultados.length;
    }

    // ----------------- EscÃ¡ner (solo previsualiza; no guarda) -----------------
    let lector = null;
    scanBtn.addEventListener("click", async ()=>{
      if(lector){
        await lector.stop();
        lector = null;
        divLector.style.display = "none";
        return;
      }
      divLector.style.display = "block";
      lector = new Html5Qrcode("lector");
      try{
        await lector.start(
          { facingMode: "environment" },
          { fps: 10, qrbox: 240 },
          async codigo => {
            await lector.stop(); lector = null; divLector.style.display="none";
            inputCodigo.value = codigo;
            try{
              await previsualizar();
              inputCantidad.focus();
            }catch(e){
              abrirModal();
              inputBuscador.value = codigo;
              buscarProductos(codigo);
            }
          },
          err => {}
        );
      }catch(e){
        console.error("Error cÃ¡mara:", e);
        alert("No se pudo abrir la cÃ¡mara");
      }
    });

    // ----------------- Persistencia mÃ­nima -----------------
    function persistLocal(){
      localStorage.setItem("folioInventarioAnuales", folio);
      localStorage.setItem("claveInventarioAnuales", inputClave.value.trim());
      localStorage.setItem("usuarioInventarioAnuales", selectUsuario.value);
      localStorage.setItem("sucursalInventarioAnuales", selectSucursal.value);
    }
    inputClave.addEventListener("change", persistLocal);
    selectUsuario.addEventListener("change", persistLocal);
    selectSucursal.addEventListener("change", persistLocal);

  </script>
</body>
</html>
