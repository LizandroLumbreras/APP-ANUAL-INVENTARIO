<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <title>INVENTARIOS ANUALES PROVEEDORA</title>

  <!-- Fuente y librerÃ­a del escÃ¡ner -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/html5-qrcode"></script>

  <style>
    :root{
      --wm-size: clamp(600px, 80vmin, 1400px);
      --wm-opacity: .14;
      --wm-rotate: 0deg;
      --wm-blend: normal;
      --azul:#00416A; --accent:#0c6cbd;
      --card:#ffffff;
    }
    *{ box-sizing: border-box }
    html,body{min-height:100%}
    body{
      font-family:'Poppins',sans-serif;
      background:linear-gradient(to right,#00416A,#E4E5E6);
      color:white; padding:16px; margin:0;
    }
    h1{ text-align:center; margin:6px 0 12px }

    .fila{ display:flex; flex-wrap:wrap; gap:10px; align-items:center }
    .folio-box{ background:white; color:#00416A; font-weight:700; padding:6px 12px; border-radius:8px; display:inline-block }
    input,button,select{ font-family:inherit; padding:12px; font-size:16px; border-radius:10px; border:none }
    input[type="text"], input[type="number"]{ width:100%; max-width:320px }
    /* Cantidad compacta en desktop */
    .qty{ max-width:140px }
    input[type="number"]{ -moz-appearance:textfield }
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button{ -webkit-appearance: none; margin: 0; }
    select{ min-width:220px }
    .boton{ background:#0c6cbd; color:white; font-weight:700; cursor:pointer; transition:filter .2s; border-radius:12px }
    .boton:active{ filter:brightness(.9) }
    .btn-ghost{ background:#e8edf6; color:#0c2a5e; font-weight:600; border-radius:12px }

    .sec{ margin-top:12px }
    .contenedor-tabla{ background:var(--card); color:#111; border-radius:12px; overflow:hidden; margin-top:14px }
    table{ width:100%; border-collapse:collapse; min-width:760px }
    th,td{ padding:10px; border-bottom:1px solid #e5e7eb; text-align:left; vertical-align:middle }
    th{ background-color:#00416A; color:white; position:sticky; top:0; z-index:1; text-align:center }
    td{ text-align:center }
    .resumen{
      background:rgba(255,255,255,.15); border:1px solid rgba(255,255,255,.25);
      border-radius:12px; padding:10px; display:flex; gap:16px; flex-wrap:wrap
    }

    .wm-logo{ position:fixed; inset:0; z-index:0; pointer-events:none; }
    .wm-logo img{
      position:absolute; top:50%; left:50%;
      transform: translate(-50%, -50%) rotate(var(--wm-rotate));
      width: var(--wm-size); height:auto;
      opacity: var(--wm-opacity);
      mix-blend-mode: var(--wm-blend);
      filter: grayscale(20%) saturate(120%) contrast(105%);
    }
    main{ position:relative; z-index:1; max-width:980px; margin:0 auto; }

    .muted{opacity:.9}
    .chip{ background:white; color:#00416A; border-radius:100px; padding:4px 10px; font-size:12px; font-weight:600 }

    /* Modal buscador */
    .modal{ position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:50; padding:10px }
    .modal .box{
      width:min(960px,96vw); max-height:90vh; overflow:auto; background:#f9f9fb; color:#111; border-radius:12px; padding:14px; box-shadow:0 12px 28px rgba(0,0,0,.3)
    }
    .modal header{ display:flex; gap:10px; align-items:center; justify-content:space-between; margin-bottom:8px; position:sticky; top:0; background:#f9f9fb; padding-bottom:6px; z-index:1 }
    .modal header .left{ display:flex; gap:10px; align-items:center; flex-wrap:wrap }
    .modal input[type="text"]{ border:1px solid #ddd; background:white; color:#111; width: min(560px, 86vw) }
    .modal .grid{ display:grid; grid-template-columns:1fr; gap:10px }
    @media (min-width:720px){ .modal .grid{ grid-template-columns:1fr 1fr } }
    .producto-card{
      border:2px solid #333; border-radius:10px; padding:10px; background:#fff;
      box-shadow: 2px 2px 6px rgba(0,0,0,0.08);
    }
    .precios{ margin-top:6px; display:flex; flex-direction:column; gap:2px; font-size:14px }
    .btn-ok{ background:#1e8e3e; color:white; font-weight:700; border-radius:10px; padding:8px 10px }

    /* Tarjeta de previsualizaciÃ³n */
    .preview{
      margin-top:10px; background:#ffffffdd; color:#111; border-radius:12px; padding:10px;
      border:2px dashed #0c6cbd; max-width:820px;
    }
    .preview .title{ font-weight:700; color:#0c2a5e }
    .preview .row{ display:flex; gap:12px; flex-wrap:wrap; margin-top:6px }
    .preview .pill{ background:#e8edf6; padding:6px 12px; border-radius:999px; font-weight:600; }

    /* ====== MOBILE ====== */
    @media (max-width: 640px){
      body{ padding:10px }
      h1{ font-size:20px }
      .fila{ gap:8px }
      label{ width:100%; font-size:14px; opacity:.95 }
      input[type="text"], input[type="number"], select{ max-width:none; width:100% }
      .boton, .btn-ghost{ width:100% }
      .contenedor-tabla{ border-radius:12px; overflow:hidden }
      /* Tabla -> Cards */
      table{ border:0; min-width:0 }
      thead{ display:none }
      tbody tr{
        display:block; background:#fff; margin:10px; border:1px solid #e5e7eb; border-radius:12px; overflow:hidden;
        box-shadow:0 4px 10px rgba(0,0,0,.06);
      }
      tbody td{
        display:flex; justify-content:space-between; align-items:center;
        padding:10px 12px; border-bottom:1px solid #f1f5f9; text-align:left !important;
      }
      tbody td::before{
        content: attr(data-label);
        font-weight:700; color:#0c2a5e; margin-right:12px;
      }
      tbody td:last-child{ border-bottom:0 }

      /* Dock de acciones rÃ¡pidas */
      .dock{
        position:fixed; left:0; right:0; bottom:0; z-index:60;
        padding:8px 10px env(safe-area-inset-bottom);
        background:linear-gradient(180deg, rgba(0,0,0,0) 0%, rgba(0,38,73,.25) 20%, rgba(0,65,106,.65) 100%);
        backdrop-filter: blur(8px);
      }
      .dock .row{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px }
      .dock .row button{ padding:12px 10px; border-radius:14px; font-weight:800; font-size:15px }
      .qty{ max-width:none; width:100% } /* cantidad full en mÃ³vil */
    }

    @media (max-width: 380px){
      .dock .row{ grid-template-columns:1fr 1fr; }
      .dock .row button[data-role="add"]{ grid-column:1 / -1 }
    }

    @media print{ .wm-logo{ display:none } .modal{ display:none !important } .dock{ display:none !important } }
  </style>
</head>
<body>
  <div class="wm-logo"><img src="logo-proveedora.webp" alt=""></div>

  <main>
    <h1>INVENTARIOS ANUALES PROVEEDORA</h1>

    <div class="fila">
      <div>Folio actual: <span class="folio-box" id="folio"></span></div>
      <span class="chip" id="chipModo">Modo: Acumular</span>
    </div>

    <div class="fila sec">
      <label for="sucursal">Sucursal:</label>
      <select id="sucursal">
        <option value="">-- Selecciona sucursal --</option>
        <option>osito</option><option>provileon</option><option>central</option><option>matriz</option>
        <option>bodega saul</option><option>bodega abarrotes</option><option>bodega dulces</option>
        <option>zapata</option><option>allende</option><option>allende 2</option>
      </select>

      <label for="usuario">Usuario:</label>
      <select id="usuario">
        <option value="">-- Selecciona usuario --</option>
        <option value="Blanca">Blanca</option><option value="Lizandro">Lizandro</option>
        <option value="Edgardo">Edgardo</option><option value="Fernanda">Fernanda</option>
        <option value="Vansessa">Vansessa</option><option value="Esmeralda">Esmeralda</option>
        <option value="Gibran">Gibran</option><option value="Roberto">Roberto</option>
        <option value="Usuario 1">Usuario 1</option><option value="Usuario 2">Usuario 2</option>
        <option value="Usuario 3">Usuario 3</option><option value="Usuario 4">Usuario 4</option>
        <option value="Usuario 5">Usuario 5</option>
      </select>
    </div>

    <div class="fila sec">
      <input type="text" id="codigo" placeholder="Escanea o escribe el cÃ³digo de barras..." autocomplete="off" inputmode="numeric">
      <input type="number" id="cantidad" class="qty" placeholder="Cantidad" step="0.001" min="0.001" inputmode="decimal">
      <button class="boton" id="agregar">âž• Agregar (guardar)</button>
      <button class="boton" id="abrirBuscador">ðŸ”Ž Buscar</button>
      <button class="boton" id="scanBtn">ðŸ“· Escanear</button>
    </div>

    <!-- PrevisualizaciÃ³n -->
    <div id="preview" class="preview" style="display:none">
      <div class="title">PrevisualizaciÃ³n del artÃ­culo</div>
      <div class="row">
        <span id="pDesc" class="pill"></span>
        <span id="pCodigo" class="pill"></span>
        <span id="pPeso" class="pill" style="display:none"></span>
      </div>
      <div id="pAviso" style="margin-top:8px" class="muted"></div>
    </div>

    <div id="lector" style="display:none; background:#fff; padding:10px; border-radius:8px; width:min(420px,92vw)"></div>

    <div class="contenedor-tabla">
      <table>
        <thead>
          <tr>
            <th>#</th><th>DescripciÃ³n</th><th>CÃ³digo</th><th>Cantidad</th><th>Fecha</th>
          </tr>
        </thead>
        <tbody id="tabla-productos"></tbody>
      </table>
    </div>

    <div class="resumen sec">
      <div><b>Renglones (solo Ãºltimo):</b> <span id="tRenglones">0</span></div>
      <div><b>Cantidad (Ãºltimo):</b> <span id="tCantidad">0.000</span></div>
    </div>
  </main>

  <!-- Dock mÃ³vil -->
  <div class="dock" id="dock" style="display:none">
    <div class="row">
      <button class="btn-ghost" id="dockBuscar" title="Buscar">ðŸ”Ž Buscar</button>
      <button class="btn-ghost" id="dockScan" title="Escanear">ðŸ“· Escanear</button>
      <button class="boton" data-role="add" id="dockAdd" title="Agregar">âž• Agregar</button>
    </div>
  </div>

  <!-- Modal Buscador -->
  <div class="modal" id="modal">
    <div class="box">
      <header>
        <div class="left">
          <strong>ðŸ”Ž Buscador de artÃ­culos</strong>
          <input type="text" id="buscador" placeholder="Escribe cÃ³digo o nombre...">
        </div>
        <div class="right">
          <button class="btn-ghost" id="cerrarModal">âœ– Cerrar</button>
        </div>
      </header>

      <div class="muted" style="padding:6px 2px">
        <progress id="barraProgreso" value="0" max="100" style="width:180px"></progress>
        <span id="estado"></span>
      </div>

      <div id="resultados" class="grid"></div>

      <div class="paginacion">
        <button id="prev" class="btn-ghost" disabled>â¬… Anterior</button>
        <span id="contador" class="muted"></span>
        <button id="next" class="btn-ghost" disabled>Siguiente âž¡</button>
      </div>
    </div>
  </div>

  <footer style="text-align:center; margin-top:18px; opacity:.9">
    Powered by <b>PROVSOFT</b>
  </footer>

  <script type="module">
    // --------- Firebase ----------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, getDoc, query, where, doc, limit } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
      authDomain: "inventariopv-643f1.firebaseapp.com",
      projectId: "inventariopv-643f1",
      storageBucket: "inventariopv-643f1.appspot.com",
      messagingSenderId: "96242533231",
      appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);
    const DEC_CANTIDAD = 3;

    // --------- Utils ----------
    const pad2 = (n) => String(n).padStart(2,'0');
    const fechaLocal = (d = new Date()) =>
      `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())} ${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;
    const roundTo = (num, dec) => Math.round((Number(num) + Number.EPSILON) * 10**dec) / 10**dec;
    const fmt = (num, dec) => Number(num ?? 0).toFixed(dec);
    const $ = (id) => document.getElementById(id);

    // Folio Ãºnico con sufijo aleatorio cripto (evita colisiones entre usuarios)
    function generarFolio() {
      const d = new Date();
      const p = n => String(n).padStart(2,'0');
      const ymd = `${d.getFullYear()}${p(d.getMonth()+1)}${p(d.getDate())}-${p(d.getHours())}${p(d.getMinutes())}${p(d.getSeconds())}`;
      const buf = new Uint32Array(1);
      (self.crypto || window.crypto).getRandomValues(buf);
      const rand = (buf[0] >>> 0).toString(36).toUpperCase().slice(-5);
      return `AnualesPDD-${ymd}-${rand}`;
    }

    // Beep corto al leer cÃ³digo
    function beep(ms=120, freq=880){
      try{
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.frequency.value = freq;
        osc.connect(gain); gain.connect(ctx.destination);
        gain.gain.setValueAtTime(0.2, ctx.currentTime);
        osc.start();
        setTimeout(()=>{ osc.stop(); ctx.close(); }, ms);
      }catch(e){ /* silencioso si no hay WebAudio */ }
    }

    // --------- DOM refs ----------
    const inputCodigo   = $("codigo");
    const inputCantidad = $("cantidad");
    const selectUsuario = $("usuario");
    const selectSucursal= $("sucursal");
    const btnAgregar    = $("agregar");
    const folioSpan     = $("folio");
    const tabla         = $("tabla-productos");
    const tRenglones    = $("tRenglones");
    const tCantidad     = $("tCantidad");

    const chipModo      = $("chipModo");

    // Preview
    const previewBox = $("preview");
    const pDesc = $("pDesc");
    const pCodigo = $("pCodigo");
    const pPeso = $("pPeso");
    const pAviso = $("pAviso");

    // Buscador
    const modal = $("modal");
    const abrirBuscadorBtn = $("abrirBuscador");
    const cerrarModalBtn = $("cerrarModal");
    const inputBuscador = $("buscador");
    const resultadosDiv = $("resultados");
    const barraProgreso = $("barraProgreso");
    const estado = $("estado");
    const contador = $("contador");
    const btnPrev = $("prev");
    const btnNext = $("next");

    // EscÃ¡ner
    const scanBtn = $("scanBtn");
    const divLector = $("lector");

    // Dock
    const dock = $("dock");
    const dockAdd = $("dockAdd");
    const dockScan = $("dockScan");
    const dockBuscar = $("dockBuscar");

    // --------- Estado ----------
    let ultimoRegistro = null;
    let productoPreview = null;
    let folio = localStorage.getItem("folioInventarioAnuales") || generarFolio();
    let cacheProductos = JSON.parse(localStorage.getItem("cacheProductosAnuales") || "{}");

    chipModo.textContent = "Modo: Acumular";
    folioSpan.textContent = folio;

    // Mostrar dock segÃºn tamaÃ±o
    const mostrarDock = () => {
      if (window.matchMedia("(max-width: 640px)").matches) dock.style.display = "block";
      else dock.style.display = "none";
    };
    mostrarDock();
    window.addEventListener("resize", mostrarDock);

    // --------- Balanzas ----------
    function detectarCodigoPeso(codigoStr){
      if(/^\d{13}$/.test(codigoStr) && codigoStr.startsWith("20")){
        const base = codigoStr.substring(0,7);
        const pesoNum = parseInt(codigoStr.substring(7,12),10);
        const pesoKg = pesoNum/1000;
        return {base, pesoKg};
      }
      return null;
    }

    // --------- Productos ----------
    async function buscarEnEquivalencias(codigoInput) {
      const codigoStr = String(codigoInput).trim();
      const q = query(collection(db,"productos"), where("codigosEquivalentes","array-contains",codigoStr));
      const snap = await getDocs(q);
      if(!snap.empty){
        const docu = snap.docs[0];
        return {principal: docu.id, data: docu.data()};
      }
      return null;
    }

    async function getProductoPorId(id){
      const ref = doc(db,"productos",id);
      const byId = await getDoc(ref);
      if(byId.exists()){
        return { id, ...byId.data() };
      }
      return null;
    }

    async function resolverProducto(codigoInput){
      const codigoStr = String(codigoInput).trim();

      // Peso/balanza
      const detectado = detectarCodigoPeso(codigoStr);
      if(detectado){
        const eq = await buscarEnEquivalencias(detectado.base);
        if(eq && eq.principal){
          const d = eq.data || (await getProductoPorId(eq.principal));
          if(d){
            return {
              descripcion: d.concepto ?? "Sin descripciÃ³n",
              codigo: eq.principal,
              cantidad: roundTo(detectado.pesoKg, DEC_CANTIDAD),
              isPeso: true
            };
          }
        }
      }

      if(cacheProductos[codigoStr]) return cacheProductos[codigoStr];

      // codigoBarra
      let q1 = query(collection(db,"productos"), where("activo","==",true), where("codigoBarra","==",codigoStr), limit(1));
      let s1 = await getDocs(q1);
      if(!s1.empty){
        const d = s1.docs[0].data();
        return { descripcion: d.concepto ?? "Sin desc", codigo: s1.docs[0].id };
      }

      // equivalentes
      const eq = await buscarEnEquivalencias(codigoStr);
      if(eq && eq.principal){
        const d = eq.data || (await getProductoPorId(eq.principal));
        if(d){ return { descripcion: d.concepto ?? "Sin desc", codigo: eq.principal }; }
      }

      // id directo
      const byId = await getProductoPorId(codigoStr);
      if(byId){ return { descripcion: byId.concepto ?? "Sin desc", codigo: byId.id }; }

      throw new Error("Producto no encontrado");
    }

    // --------- PrevisualizaciÃ³n ----------
    async function previsualizar(){
      const codigo = (inputCodigo.value||"").trim();
      if(!codigo){ ocultarPreview(); return; }

      const p = await resolverProducto(codigo);
      productoPreview = { descripcion:p.descripcion, codigo:p.codigo, cantidad: p.cantidad, isPeso: !!p.isPeso };

      pDesc.textContent   = p.descripcion || "SIN DESCRIPCIÃ“N";
      pCodigo.textContent = `CÃ³digo: ${p.codigo}`;

      if(p.isPeso){
        pPeso.style.display = "inline-block";
        pPeso.textContent = `Peso detectado: ${fmt(p.cantidad, DEC_CANTIDAD)} kg`;
        inputCantidad.value = fmt(p.cantidad, DEC_CANTIDAD);            // solo si balanza
        pAviso.innerHTML = `<span class="ok">âœ” CÃ³digo de balanza detectado.</span> Ajusta la cantidad si es necesario y luego presiona <b>Agregar</b>.`;
      }else{
        pPeso.style.display = "none";
        inputCantidad.value = "";                                       // dejar vacÃ­o
        pAviso.innerHTML = `<span class="warn">âŒ› PrevisualizaciÃ³n lista.</span> Captura la cantidad y presiona <b>Agregar</b> para guardar.`;
      }
      previewBox.style.display = "block";
    }

    function ocultarPreview(){
      previewBox.style.display = "none";
      pDesc.textContent = ""; pCodigo.textContent = ""; pPeso.textContent = ""; pPeso.style.display="none";
      pAviso.textContent = "";
      productoPreview = null;
    }

    // Enter en cÃ³digo â†’ previsualiza y enfoca cantidad
    inputCodigo.addEventListener("keydown", e=>{
      if(e.key==="Enter"){ e.preventDefault(); previsualizar().then(()=> inputCantidad.focus()); }
    });
    inputCodigo.addEventListener("blur", ()=>{ if(inputCodigo.value.trim()) previsualizar(); });

    // --------- Guardado ----------
    async function guardarRegistroInmediato(item){
      if(!selectSucursal.value) throw new Error("Selecciona una sucursal");
      if(!selectUsuario.value) throw new Error("Selecciona un usuario");

      const folioRegistro = generarFolio();

      const registro = {
        folioSesion: folio,
        folioRegistro,
        fecha: fechaLocal(),
        epochMs: Date.now(),
        sucursal: selectSucursal.value,
        usuario: selectUsuario.value,
        descripcion: item.descripcion,
        codigo: item.codigo,
        cantidad: Number(item.cantidad || 0)
      };

      await addDoc(
        collection(db,"inventarios", selectSucursal.value, "usuarios", selectUsuario.value, "escaneos"),
        registro
      );

      ultimoRegistro = registro;
      renderTablaUltimo();
    }

    function renderTablaUltimo(){
      tabla.innerHTML = "";
      if(!ultimoRegistro){
        tRenglones.textContent = "0";
        tCantidad.textContent  = "0.000";
        return;
      }
      const p = ultimoRegistro;
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td data-label="#">1</td>
        <td data-label="DescripciÃ³n">${p.descripcion}</td>
        <td data-label="CÃ³digo">${p.codigo}</td>
        <td data-label="Cantidad">${fmt(p.cantidad, DEC_CANTIDAD)}</td>
        <td>${p.fecha || ""}</td>
      `;
      tabla.appendChild(tr);
      tRenglones.textContent = "1";
      tCantidad.textContent  = fmt(p.cantidad, DEC_CANTIDAD);
      persistLocal();
    }

    // Agregar
    const agregarYGuardar = async ()=>{
      try{
        let p = productoPreview;
        if(!p){ await previsualizar(); p = productoPreview; }
        if(!p) throw new Error("Primero escanea/escribe un cÃ³digo vÃ¡lido");

        let cantidad = roundTo(parseFloat(inputCantidad.value || (p.cantidad ?? "1")), DEC_CANTIDAD);
        if(isNaN(cantidad) || cantidad<=0) throw new Error("Cantidad invÃ¡lida");

        await guardarRegistroInmediato({ descripcion: p.descripcion, codigo: p.codigo, cantidad });

        // limpiar para siguiente
        inputCodigo.value = "";
        inputCantidad.value = "";           // queda vacÃ­o
        ocultarPreview();
        inputCodigo.focus();
      }catch(e){
        alert(e.message || "Error al guardar");
      }
    };

    $("agregar").addEventListener("click", agregarYGuardar);
    inputCantidad.addEventListener("keydown", e=>{
      if(e.key==="Enter"){ e.preventDefault(); agregarYGuardar(); }
    });

    // --------- Buscador ----------
    function abrirModal(){ modal.style.display="flex"; inputBuscador.focus(); }
    function cerrarModal(){ modal.style.display="none"; resultadosDiv.innerHTML=""; contador.textContent=""; estado.textContent=""; barraProgreso.value=0; }
    $("abrirBuscador").addEventListener("click", abrirModal);
    $("cerrarModal").addEventListener("click", cerrarModal);
    modal.addEventListener("click", (e)=>{ if(e.target===modal) cerrarModal(); });

    let resultados=[], pagina=0; const porPagina=20; let debounceTimer;

    $("buscador").addEventListener("input", ()=>{
      clearTimeout(debounceTimer);
      const termino = inputBuscador.value.trim();
      if(!termino){ resultadosDiv.innerHTML=""; contador.textContent=""; return; }
      debounceTimer = setTimeout(()=> buscarProductos(termino), 600);
    });
    $("prev").addEventListener("click", ()=> mostrarPagina(pagina-1));
    $("next").addEventListener("click", ()=> mostrarPagina(pagina+1));

    async function buscarProductos(termino){
      resultados = [];
      resultadosDiv.innerHTML = "â³ Buscando...";
      barraProgreso.value = 10; estado.textContent = "";

      if(/^\d+$/.test(termino)){
        let q1 = query(collection(db,"productos"), where("activo","==",true), where("codigoBarra","==",termino), limit(1));
        let s1 = await getDocs(q1);
        let encontradoEn = "codigoBarra";

        if(s1.empty){
          const q2 = query(collection(db,"productos"), where("activo","==",true), where("codigosEquivalentes","array-contains",termino), limit(1));
          const s2 = await getDocs(q2);
          if(!s2.empty){ s1 = s2; encontradoEn = "equivalente"; }
        }

        if(!s1.empty){
          resultados = s1.docs.map(d => ({ id:d.id, ...d.data(), coincidencia:encontradoEn, codigoBuscado:termino }));
        }else{
          resultadosDiv.innerHTML = "âŒ No se encontrÃ³ este cÃ³digo en productos ni en equivalentes";
          contador.textContent = "";
          barraProgreso.value = 100;
          return;
        }

        barraProgreso.value = 100;
        mostrarPagina(0);
        return;
      }

      barraProgreso.value = 25; estado.textContent = "Cargando productos activosâ€¦";
      const q = query(collection(db,"productos"), where("activo","==",true));
      const snap = await getDocs(q);

      const palabras = termino.toLowerCase().split(/\s+/).filter(Boolean);
      resultados = [];
      snap.forEach(docu=>{
        const p = { id: docu.id, ...docu.data() };
        if(p.concepto){
          const ok = palabras.every(pal => String(p.concepto).toLowerCase().includes(pal));
          if(ok) resultados.push(p);
        }
      });
      barraProgreso.value = 100; estado.textContent = "";

      if(!resultados.length){
        resultadosDiv.innerHTML = "âŒ No se encontraron resultados";
        contador.textContent = "";
      }else{
        mostrarPagina(0);
      }
    }

    function mostrarPagina(n){
      pagina = n;
      resultadosDiv.innerHTML = "";
      const inicio = pagina * porPagina;
      const fin = inicio + porPagina;
      const lista = resultados.slice(inicio, fin);

      lista.forEach(p=>{
        const div = document.createElement("div");
        div.className = "producto-card";

        const equivBadge = p.coincidencia==="equivalente"
          ? `<div style="color:#b00; font-size:12px">ðŸ”— Coincidencia en equivalente (${p.codigoBuscado})</div>`
          : "";

        div.innerHTML = `
          <b>${p.concepto || "SIN CONCEPTO"}</b><br>
          CÃ³digo: ${p.codigoBarra || p.id}
          ${equivBadge}
          <div style="margin-top:8px">
            <button class="btn-ok">Usar en previsualizaciÃ³n</button>
          </div>
        `;

        div.querySelector(".btn-ok").addEventListener("click", ()=>{
          productoPreview = { descripcion: p.concepto || "Sin desc", codigo: p.id };
          pDesc.textContent = productoPreview.descripcion;
          pCodigo.textContent = `CÃ³digo: ${productoPreview.codigo}`;
          pPeso.style.display = "none";
          pAviso.innerHTML = `<span class="warn">âŒ› PrevisualizaciÃ³n lista.</span> Captura la cantidad y presiona <b>Agregar</b> para guardar.`;
          previewBox.style.display = "block";
          cerrarModal();
          inputCantidad.value = "";
          inputCantidad.focus();
        });

        resultadosDiv.appendChild(div);
      });

      contador.textContent = `Resultados: ${resultados.length} | PÃ¡gina ${pagina+1} de ${Math.max(1, Math.ceil(resultados.length/porPagina))}`;
      btnPrev.disabled = pagina===0;
      btnNext.disabled = fin >= resultados.length;
    }

    // --------- EscÃ¡ner (cierra al leer, muestra desc, beep y enfoca cantidad) ----------
    let lector = null;
    scanBtn.addEventListener("click", startStopCam);
    dockScan.addEventListener("click", startStopCam);

    async function startStopCam(){
      if(lector){
        await lector.stop();
        lector = null;
        divLector.style.display = "none";
        return;
      }
      divLector.style.display = "block";
      lector = new Html5Qrcode("lector");
      try{
        const box = Math.floor(Math.min(window.innerWidth*0.8, 320));
        await lector.start(
          { facingMode: "environment" },
          { fps: 10, qrbox: box },
          async codigo => {
            try{
              // Detener cÃ¡mara inmediatamente
              await lector.stop(); lector = null; divLector.style.display="none";
            }catch(_){}
            // Setear cÃ³digo, previsualizar, beep y enfocar cantidad
            inputCodigo.value = codigo;
            try{
              await previsualizar();
              beep();                 // sonido de confirmaciÃ³n
              inputCantidad.focus();
            }catch(e){
              abrirModal();
              inputBuscador.value = codigo;
              buscarProductos(codigo);
            }
          },
          err => {}
        );
      }catch(e){
        console.error("Error cÃ¡mara:", e);
        alert("No se pudo abrir la cÃ¡mara");
      }
    }

    // --------- Persistencia mÃ­nima ----------
    function persistLocal(){
      localStorage.setItem("folioInventarioAnuales", folio);
      localStorage.setItem("usuarioInventarioAnuales", selectUsuario.value);
      localStorage.setItem("sucursalInventarioAnuales", selectSucursal.value);
    }
    selectUsuario.addEventListener("change", persistLocal);
    selectSucursal.addEventListener("change", persistLocal);

    // Dock acciones
    dockAdd.addEventListener("click", ()=> $("agregar").click());
    dockBuscar.addEventListener("click", ()=> $("abrirBuscador").click());
  </script>
</body>
</html>
